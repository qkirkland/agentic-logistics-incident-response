┌─────────────────────────────────────────────────────────────────────────┐
│                         PEPSICO SUPPLY CHAIN                             │
│                    INCIDENT PROCESSING SYSTEM                            │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│  EXTERNAL        │
│  LOGISTICS       │     Truck Breakdown Detected
│  PROVIDER        │     (Transmission Failure)
│  (Schneider)     │              │
└──────────────────┘              │
                                  ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                          SERVICENOW PLATFORM                             │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  DELIVERY DELAY TABLE                                           │    │
│  │  ─────────────────────                                          │    │
│  │  route_id: 665145                                               │    │
│  │  truck_id: 2442                                                 │    │
│  │  problem: "Breakdown at TX-130 MM 56"                           │    │
│  │  proposed_routes: [opt-1, opt-2, opt-3]                         │    │
│  │  status: "pending" ◄─── TRIGGER POINT                           │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                  │                                       │
│                                  ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  TRIGGER                                                         │    │
│  │  ───────                                                         │    │
│  │  Condition: status = "pending"                                  │    │
│  │  Activates: Agent 1                                             │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                  │                                       │
│                                  ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  AGENT 1: ROUTE FINANCIAL ANALYSIS                              │    │
│  │  ────────────────────────────────                               │    │
│  │  Tools: Look Up Delivery Delay                                  │    │
│  │         Look Up Supply Agreement ──────────────────┐            │    │
│  │         Create Incident                            │            │    │
│  │         Update Delivery Delay Script               │            │    │
│  │                                                     ↓            │    │
│  │  Calculations:                      ┌─────────────────────────┐ │    │
│  │  • Option 1: $1,007.50             │  SUPPLY AGREEMENT       │ │    │
│  │  • Option 2: $1,167.50             │  TABLE                  │ │    │
│  │  • Option 3: $292.50 ✓             │  ─────────────          │ │    │
│  │                                     │  customer: Whole Foods  │ │    │
│  │  Creates Incident Record           │  window: 3 hours        │ │    │
│  │  Updates: calculated_impact        │  penalty: $250/hr       │ │    │
│  │           status → "calculated"    └─────────────────────────┘ │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                  │                                       │
│                                  ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  DELIVERY DELAY TABLE (Updated)                                 │    │
│  │  calculated_impact: {all 3 options with penalties}              │    │
│  │  status: "calculated" ◄─── TRIGGERS AGENT 2                     │    │
│  │  incident_sys_id: "abc123..."                                   │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                  │                                       │
│                                  ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  AGENT 2: ROUTE DECISION                                        │    │
│  │  ──────────────────────                                         │    │
│  │  Tools: Look Up Delivery Delay                                  │    │
│  │         Update Delivery Delay                                   │    │
│  │         Update Incident                                         │    │
│  │         Trigger n8n Workflow (Webhook)                          │    │
│  │                                                                  │    │
│  │  Decision Logic:                                                │    │
│  │  • Analyzes calculated_impact                                   │    │
│  │  • Selects Option 3 (lowest cost: $292.50)                      │    │
│  │  • Sets priority: 3 (Moderate)                                  │    │
│  │  • Updates status → "approved"                                  │    │
│  │  • Calls n8n webhook with routing data                          │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                  │                                       │
│                                  │ Webhook Payload:                      │
│                                  │ {route_id, truck_id, chosen_option}   │
└──────────────────────────────────┼───────────────────────────────────────┘
                                   │
                                   │ HTTPS
                                   ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                              N8N PLATFORM                                │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  WEBHOOK NODE                                                   │    │
│  │  ────────────                                                   │    │
│  │  Receives: {route_id: "665145",                                 │    │
│  │             truck_id: "2442",                                   │    │
│  │             chosen_option: {...}}                               │    │
│  │  Response Mode: Immediately                                     │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                  │                                       │
│                                  ↓                                       │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  AI AGENT - ROUTE COORDINATOR                                   │    │
│  │  ───────────────────────────                                    │    │
│  │  Model: AWS Bedrock Claude Sonnet 4.5                           │    │
│  │                                                                  │    │
│  │  Tools (MCP Clients):                                           │    │
│  │  ├─ Logistics MCP Client (8001)                                 │    │
│  │  ├─ Retail MCP Client (8002)                                    │    │
│  │  └─ ServiceNow MCP Client (8000)                                │    │
│  │                                                                  │    │
│  │  Coordinates 3 parallel external system calls                   │    │
│  └────────────────────────────────────────────────────────────────┘    │
│         │                    │                    │                      │
│         │                    │                    │                      │
└─────────┼────────────────────┼────────────────────┼──────────────────────┘
          │                    │                    │
          │                    │                    │
   ┌──────▼──────┐     ┌───────▼────────┐   ┌─────▼──────┐
   │ LOGISTICS   │     │  RETAIL MCP    │   │ SERVICENOW │
   │ MCP SERVER  │     │  SERVER        │   │ MCP SERVER │
   │             │     │                │   │            │
   │ :8001       │     │  :8002         │   │ :8000      │
   │             │     │                │   │            │
   │ execute_    │     │  notify_       │   │ update_    │
   │ route()     │     │  delivery_     │   │ execution_ │
   │             │     │  delay()       │   │ status()   │
   └──────┬──────┘     └───────┬────────┘   └─────┬──────┘
          │                    │                    │
          │ ✓ Route           │ ✓ Customer        │ ⚠ Token
          │ Confirmed         │ Notified          │ Issue
          │                    │                    │
          └────────────────────┴────────────────────┘
                              │
                              ↓
                  ┌───────────────────────┐
                  │ BACK TO SERVICENOW    │
                  │ Status: "dispatched"  │
                  │ (Target - Pending)    │
                  └───────────────────────┘
